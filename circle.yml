machine:
  node:
    version: 8.1.0
  environment:
    PATH: "${PATH}:${HOME}/${CIRCLE_PROJECT_REPONAME}/node_modules/.bin"

  services:
    - docker
    - redis
    - postgresql

dependencies:
  cache_directories:
    - ~/.yarn
    - ~/.cache/yarn
  override:
    - yarn
    - bundle check --path=vendor/bundle || bundle install --without development --path=vendor/bundle --jobs=4 --retry=3

database:
  override:
    - bundle exec rake RAILS_ENV=test db:create db:migrate db:seed champaign:seed_liquid

test:
  override:
    - |
      yarn run test &&
      bundle exec rspec spec
    # Temporarily disabling flow & rubocop
    # - |
    #   yarn run lint &&
    #   yarn run flow-check &&
    #   yarn run test &&
    #   bundle exec rubocop &&
    #   bundle exec rspec spec
  post:
    # Update docker version
    - curl -sSL https://s3.amazonaws.com/circle-downloads/install-circleci-docker.sh | bash -s -- 1.10.0
    - docker info
    # install AWS CLI
    - sudo pip install awscli
    - cat Dockerrun.aws.json.template | envsubst > Dockerrun.aws.json

deployment:
  pre:
    - echo "Checking if pre deploy step exists?"
  production:
    branch: 'master'
    commands:
      - ./bin/build.sh
      - ./bin/deploy.sh $CIRCLE_SHA1 'champaign' 'env-production' 'champaign-assets-production' 'logs3.papertrailapp.com:44107' 'actions.sumofus.org'
  staging:
    branch:  'development'
    commands:
      - ./bin/build.sh
      - ./bin/deploy.sh $CIRCLE_SHA1 'champaign' 'env-staging' 'champaign-assets-staging' 'logs3.papertrailapp.com:34848' 'action-staging.sumofus.org'
  testing:
    branch: testing
    commands:
      - ./bin/build.sh
      - ./bin/deploy_testing.sh $CIRCLE_SHA1 'champaign' 'champaign-testing' 'champaign-assets-testing'
