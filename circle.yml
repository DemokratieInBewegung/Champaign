machine:
  pre:
    # Update docker version
    - curl -sSL https://s3.amazonaws.com/circle-downloads/install-circleci-docker.sh | bash -s -- 1.10.0
  node:
    version: 8.1.0
  environment:
    PATH: "${PATH}:${HOME}/${CIRCLE_PROJECT_REPONAME}/node_modules/.bin"

  services:
    - docker
    - redis
    - postgresql

dependencies:
  cache_directories:
    - ~/.cache/yarn
  override:
    - echo $CUSTOM_ASSETS_URL
    - echo $CUSTOM_ASSETS_CREDENTIALS
    - echo $EXTERNAL_ASSET_PATHS
    - docker info
    - sudo pip install awscli
    - yarn
    - bundle check || bundle install --without development --jobs=4 --retry=3
    - cat Dockerrun.aws.json.template | envsubst > Dockerrun.aws.json

database:
  override:
    - bundle exec rake RAILS_ENV=test db:create db:migrate db:seed champaign:seed_liquid

test:
  override:
    - |
      yarn run flow &&
      yarn run test &&
      bundle exec rspec spec

deployment:
  production:
    branch: 'master'
    commands:
      - ./bin/build.sh
      - ./bin/deploy.sh $CIRCLE_SHA1 'champaign' 'env-production' 'champaign-assets-production' 'logs3.papertrailapp.com:44107' 'actions.sumofus.org'
  staging:
    branch:  'rails_5'
    commands:
      - ./bin/build.sh
      - ./bin/deploy.sh $CIRCLE_SHA1 'champaign' 'env-staging' 'champaign-assets-staging' 'logs3.papertrailapp.com:34848' 'action-staging.sumofus.org'
